  <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Medical Input & Blockchain Record Fetcher</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h1>Blockchain Record Fetcher</h1>
    <!-- Record Fetcher Sections -->
    <div class="form-section">
    <div class="fetch-container">
        <button id="fetchAllUserDiabetesButton" onclick="fetchAllUserDiabetesRecords()">Fetch All User Diabetes Records</button>
        <div id="fetchAllUserDiabetesLoadingIndicator" class="loading-indicator"></div>
      </div>
      
      <div class="fetch-container">
        <button id="fetchAllUserHeartButton" onclick="fetchAllUserHeartRecords()">Fetch All User Heart Records</button>
        <div id="fetchAllUserHeartLoadingIndicator" class="loading-indicator"></div>
      </div>
      
      <div class="fetch-container">
        <button id="fetchAllUserLungButton" onclick="fetchAllUserLungRecords()">Fetch All User Lung Records</button>
        <div id="fetchAllUserLungLoadingIndicator" class="loading-indicator"></div>
      </div>
      

    <!-- Display Records -->
    <div id="recordDisplay" class="record-display"></div>
  </div>

  <div class="form-container">
    <h2>Medical Input Form</h2>
    <!-- Buttons to switch between forms -->
    <div class="form-groups">
      <button type="button" onclick="showForm('basicForm')">Diabetes</button>
      <button type="button" onclick="showForm('fullForm')">Heart</button>
      <button type="button" onclick="showForm('lungForm')">Lung Cancer</button>
    </div>

    <!-- Diabetes Form -->
    <form id="basicForm" class="hidden">
      <h3>Diabetes Metrics</h3>
      <div class="form-group">
        <label for="pregnancies">Pregnancies</label>
        <input type="number" id="pregnancies" name="pregnancies" value="0" />
      </div>
      <div class="form-group">
        <label for="glucose">Glucose</label>
        <input type="number" id="glucose" name="glucose" value="0" />
      </div>
      <div class="form-group">
        <label for="bloodPressure">Blood Pressure</label>
        <input type="number" id="bloodPressure" name="bloodPressure" value="0" />
      </div>
      <div class="form-group">
        <label for="skinThickness">Skin Thickness</label>
        <input type="number" id="skinThickness" name="skinThickness" value="0" />
      </div>
      <div class="form-group">
        <label for="insulin">Insulin</label>
        <input type="number" id="insulin" name="insulin" value="0" />
      </div>
      <div class="form-group">
        <label for="bmi">BMI</label>
        <input type="number" id="bmi" name="bmi" value="0" />
      </div>
      <div class="form-group">
        <label for="age">Age</label>
        <input type="number" id="age" name="age" value="0" />
      </div>
      <div class="form-group">
        <label for="diabetesPedigreeFunction">Diabetes Pedigree Function</label>
        <input type="number" id="diabetesPedigreeFunction" name="diabetesPedigreeFunction" value="0" />
      </div>
      <div class="form-group">
        <button type="button" onclick="submitForm('basicForm')">Submit Diabetes Data</button>
      </div>
    </form>

    <!-- Heart Form -->
    <form id="fullForm" class="hidden">
      <h3>Heart Metrics</h3>
      <div class="form-group">
        <label for="feature1">Feature 1</label>
        <input type="number" id="feature1" name="feature1" value="0" />
      </div>
      <div class="form-group">
        <label for="feature2">Feature 2</label>
        <input type="number" id="feature2" name="feature2" value="0" />
      </div>
      <div class="form-group">
        <label for="feature3">Feature 3</label>
        <input type="number" id="feature3" name="feature3" value="0" />
      </div>
      <div class="form-group">
        <label for="feature4">Feature 4</label>
        <input type="number" id="feature4" name="feature4" value="0" />
      </div>
      <div class="form-group">
        <label for="feature5">Feature 5</label>
        <input type="number" id="feature5" name="feature5" value="0" />
      </div>
      <div class="form-group">
        <label for="feature6">Feature 6</label>
        <input type="number" id="feature6" name="feature6" value="0" />
      </div>
      <div class="form-group">
        <label for="feature7">Feature 7</label>
        <input type="number" id="feature7" name="feature7" value="0" />
      </div>
      <div class="form-group">
        <label for="feature8">Feature 8</label>
        <input type="number" id="feature8" name="feature8" value="0" />
      </div>
      <div class="form-group">
        <label for="feature9">Feature 9</label>
        <input type="number" id="feature9" name="feature9" value="0" />
      </div>
      <div class="form-group">
        <label for="feature10">Feature 10</label>
        <input type="number" id="feature10" name="feature10" value="0" />
      </div>
      <div class="form-group">
        <label for="feature11">Feature 11</label>
        <input type="number" id="feature11" name="feature11" value="0" />
      </div>
      <div class="form-group">
        <label for="feature12">Feature 12</label>
        <input type="number" id="feature12" name="feature12" value="0" />
      </div>
      <div class="form-group">
        <label for="feature13">Feature 13</label>
        <input type="number" id="feature13" name="feature13" value="0" />
      </div>
      <div class="form-group">
        <button type="button" onclick="submitForm('fullForm')">Submit Heart Data</button>
      </div>
    </form>

    <!-- Lung Cancer Form -->
    <form id="lungForm" class="hidden">
      <h3>Lung Cancer Metrics</h3>
    
      <!-- AGE remains a number input -->
      <div class="form-group">
        <label for="AGE">AGE</label>
        <input type="number" id="AGE" name="AGE" value="0" />
      </div>
    
      <!-- All other metrics as YES/NO options -->
      <div class="form-group">
        <label>SMOKING</label>
        <label><input type="radio" name="SMOKING" value="YES" /> YES</label>
        <label><input type="radio" name="SMOKING" value="NO" checked /> NO</label>
      </div>
    
      <div class="form-group">
        <label>YELLOW FINGERS</label>
        <label><input type="radio" name="YELLOW_FINGERS" value="YES" /> YES</label>
        <label><input type="radio" name="YELLOW_FINGERS" value="NO" checked /> NO</label>
      </div>
    
      <div class="form-group">
        <label>ANXIETY</label>
        <label><input type="radio" name="ANXIETY" value="YES" /> YES</label>
        <label><input type="radio" name="ANXIETY" value="NO" checked /> NO</label>
      </div>
    
      <div class="form-group">
        <label>PEER PRESSURE</label>
        <label><input type="radio" name="PEER_PRESSURE" value="YES" /> YES</label>
        <label><input type="radio" name="PEER_PRESSURE" value="NO" checked /> NO</label>
      </div>
    
      <div class="form-group">
        <label>CHRONIC DISEASE</label>
        <label><input type="radio" name="CHRONIC_DISEASE" value="YES" /> YES</label>
        <label><input type="radio" name="CHRONIC_DISEASE" value="NO" checked /> NO</label>
      </div>
    
      <div class="form-group">
        <label>FATIGUE</label>
        <label><input type="radio" name="FATIGUE" value="YES" /> YES</label>
        <label><input type="radio" name="FATIGUE" value="NO" checked /> NO</label>
      </div>
    
      <div class="form-group">
        <label>ALLERGY</label>
        <label><input type="radio" name="ALLERGY" value="YES" /> YES</label>
        <label><input type="radio" name="ALLERGY" value="NO" checked /> NO</label>
      </div>
    
      <div class="form-group">
        <label>WHEEZING</label>
        <label><input type="radio" name="WHEEZING" value="YES" /> YES</label>
        <label><input type="radio" name="WHEEZING" value="NO" checked /> NO</label>
      </div>
    
      <div class="form-group">
        <label>ALCOHOL CONSUMING</label>
        <label><input type="radio" name="ALCOHOL_CONSUMING" value="YES" /> YES</label>
        <label><input type="radio" name="ALCOHOL_CONSUMING" value="NO" checked /> NO</label>
      </div>
    
      <div class="form-group">
        <label>COUGHING</label>
        <label><input type="radio" name="COUGHING" value="YES" /> YES</label>
        <label><input type="radio" name="COUGHING" value="NO" checked /> NO</label>
      </div>
    
      <div class="form-group">
        <label>SHORTNESS OF BREATH</label>
        <label><input type="radio" name="SHORTNESS_OF_BREATH" value="YES" /> YES</label>
        <label><input type="radio" name="SHORTNESS_OF_BREATH" value="NO" checked /> NO</label>
      </div>
    
      <div class="form-group">
        <label>SWALLOWING DIFFICULTY</label>
        <label><input type="radio" name="SWALLOWING_DIFFICULTY" value="YES" /> YES</label>
        <label><input type="radio" name="SWALLOWING_DIFFICULTY" value="NO" checked /> NO</label>
      </div>
    
      <div class="form-group">
        <label>CHEST PAIN</label>
        <label><input type="radio" name="CHEST_PAIN" value="YES" /> YES</label>
        <label><input type="radio" name="CHEST_PAIN" value="NO" checked /> NO</label>
      </div>
    
      <div class="form-group">
        <button type="button" onclick="submitForm('lungForm')">Submit Lung Cancer Data</button>
      </div>
    </form>
    
    </form>

    <!-- Loading Indicators for each form -->
    <div id="diabetesLoadingIndicator" class="loading-container" style="display: none;">
      <p>Submitting diabetes data, please wait...</p>
      <div class="spinner"></div>
    </div>
    <div id="heartLoadingIndicator" class="loading-container" style="display: none;">
      <p>Submitting heart data, please wait...</p>
      <div class="spinner"></div>
    </div>
    <div id="lungLoadingIndicator" class="loading-container" style="display: none;" >
      <p>Submitting lung cancer data, please wait...</p>
      <div class="spinner"></div>
    </div>
  </div>

  <!-- Prediction Result -->
  <div id="predictionResult" class="prediction-result" style="display: none;">
    <h3>Prediction Result</h3>
    <p id="predictionText"></p>
  </div>
</body>

  <script>
    const token = localStorage.getItem("accessToken");
    if (!token) {
      alert("You must log in first!");
      window.location.href = "login.html";
    }

    let lastSubmittedData = null;
    let isSubmitting = false;

    function showForm(formId) {
      document.getElementById('basicForm').classList.add('hidden');
      document.getElementById('fullForm').classList.add('hidden');
      document.getElementById('lungForm').classList.add('hidden');
      document.getElementById(formId).classList.remove('hidden');
    }

    async function submitForm(formId) {
      const form = document.getElementById(formId);
      const formData = new FormData(form);
      const data = {};
      formData.forEach((value, key) => {
        data[key] = isNaN(value) ? value : Number(value); 
      });
      console.log("Form Data:", data);

      try {
        let apiUrl = "";
        if (formId === "basicForm") {
          apiUrl = "https://render-1-yyer.onrender.com/predict/diabetes";
        } else if (formId === "fullForm") {
          apiUrl = "https://render-1-yyer.onrender.com/predict/heart";
        } else if (formId === "lungForm") {
          for (let key in data) {
            if (typeof data[key] === 'string') {
              data[key] = data[key].trim().toUpperCase() === "YES" ? 1 : 0;
            }
          }
          apiUrl = "https://render-1-yyer.onrender.com/predict/lung";
        }
        
        const response = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const result = await response.json();
        console.log("Response from server:", result);
        if (formId === "lungForm"){
            if(result.prediction === "YES"){
                result.prediction = 1;
            }
            else{
                result.prediction = 0;
            }
        }
        if (result.prediction !== undefined) {
          const predictionResult = document.getElementById('predictionResult');
          const predictionText = document.getElementById('predictionText');
          predictionResult.style.display = 'none';
          console.log("Prediction Value:", result.prediction);
          if (hasDataChanged(data, result.prediction)) {
            if (!isSubmitting) {
              isSubmitting = true;
              // Show the appropriate loading indicator
              if(formId === "basicForm") {
                document.getElementById('diabetesLoadingIndicator').style.display = 'block';
              } else if(formId === "fullForm") {
                document.getElementById('heartLoadingIndicator').style.display = 'block';
              } else if(formId === "lungForm") {
                document.getElementById('lungLoadingIndicator').style.display = 'block';
              }

              const returnHash = await storePredictionOnBlockchain(data, result.prediction, formId);
              if (!returnHash) {
                console.log("Prediction not stored on blockchain");
              } else {
                console.log("Prediction stored successfully on blockchain");
              }
              // Hide all loading indicators
              document.getElementById('diabetesLoadingIndicator').style.display = 'none';
              document.getElementById('heartLoadingIndicator').style.display = 'none';
              document.getElementById('lungLoadingIndicator').style.display = 'none';

              let predictionMsg = "";
              if(formId === "basicForm") {
                predictionMsg = result.prediction === 1 ? 'Patient has diabetes' : 'Patient is healthy';
              } else if(formId === "fullForm") {
                predictionMsg = result.prediction === 1 ? 'Patient has heart disease' : 'Patient is healthy';
              } else if(formId === "lungForm") {
                predictionMsg = result.prediction === 1 ? 'Patient has lung cancer' : 'Patient is healthy';
              }
              predictionText.textContent = predictionMsg;
              predictionResult.style.display = 'block';
              lastSubmittedData = { ...data, prediction: result.prediction };
            } else {
              alert("Submission already in progress, please wait.");
            }
          } else {
            alert("No change in data, not submitting to blockchain.");
          }
        } else {
          alert(`Error: ${result.error}`);
        }
      } catch (error) {
        console.error("Error while submitting form:", error);
        alert('Failed to submit the form. Please try again.');
      } finally {
        isSubmitting = false;
      }
    }

    function hasDataChanged(currentData, prediction) {
      const currentDataWithPrediction = { ...currentData, prediction };
      if (!lastSubmittedData) {
        return true;
      }
      return JSON.stringify(currentDataWithPrediction) !== JSON.stringify(lastSubmittedData);
    }

    async function refreshToken() {
      try {
        console.log("üîÑ Attempting to refresh access token...");
        const response = await fetch("https://render-9r49.onrender.com/api/user/refresh", {
          method: "POST",
          credentials: "include"
        });
        if (!response.ok) {
          console.error("Refresh token request failed:", response.status);
          return false;
        }
        const { accessToken } = await response.json();
        console.log("‚úÖ New access token received:", accessToken);
        localStorage.setItem("accessToken", accessToken);
        return true;
      } catch (error) {
        console.error("‚ùå Error refreshing token:", error);
        return false;
      }
    }

    function isTokenExpired(token) {
      try {
        const payload = JSON.parse(atob(token.split(".")[1]));
        return payload.exp * 1000 < Date.now();
      } catch (error) {
        console.error("Error decoding token:", error);
        return true;
      }
    }

    async function storePredictionOnBlockchain(formData, prediction, formId) {
      let token = localStorage.getItem("accessToken");
      if (!token) {
        alert("Session expired. Please log in again.");
        window.location.href = "login.html";
        return;
      }
      console.log("Using Access Token:", token);
      if (isTokenExpired(token)) {
        console.log("Token is expired, refreshing...");
        const refreshSuccess = await refreshToken();
        if (!refreshSuccess) {
          alert("Session expired. Please log in again.");
          window.location.href = "login.html";
          return;
        }
        token = localStorage.getItem("accessToken");
      }
      try {
        console.log("Storing data on blockchain...");
        const dataToStore = { ...formData, prediction };
        console.log("Data being stored on blockchain:", dataToStore);
        let blockchainUrl = "";
        if (formId === "basicForm") {
          blockchainUrl = "https://render-9r49.onrender.com/api/blockchain/store-diabetes";
        } else if (formId === "fullForm") {
          blockchainUrl = "https://render-9r49.onrender.com/api/blockchain/store-heart";
        } else if (formId === "lungForm") {
          blockchainUrl = "https://render-9r49.onrender.com/api/blockchain/store-lung";
        }
        const blockchainResponse = await fetch(blockchainUrl, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify([dataToStore])
        });
        if (blockchainResponse.status === 401) {
          console.log("Access token expired, trying to refresh...");
          const refreshSuccess = await refreshToken();
          if (refreshSuccess) {
            return storePredictionOnBlockchain(formData, prediction, formId);
          } else {
            alert("Session expired. Please log in again.");
            window.location.href = "login.html";
            return;
          }
        }
        if (!blockchainResponse.ok) {
          throw new Error("Failed to store data on the blockchain.");
        }
        console.log("Blockchain API response status:", blockchainResponse.status);
        const blockchainResult = await blockchainResponse.json();
        console.log("Data stored successfully on the blockchain:", blockchainResult);
        return blockchainResult;
      } catch (error) {
        console.error("Error storing data on the blockchain:", error);
        alert("Failed to store data on the blockchain. Please try again.");
      }
    }

    function disableButton(buttonId) {
        const button = document.getElementById(buttonId);
        if (!button) {
          console.warn(`Element with id "${buttonId}" not found.`);
          return;
        }
        button.disabled = true;
      }
      

    function enableButton(buttonId) {
      const button = document.getElementById(buttonId);
      button.disabled = false;
    }

    function displayRecords(records) {
      const displayDiv = document.getElementById('recordDisplay');
      displayDiv.innerHTML = '';
      if (Array.isArray(records)) {
        records.forEach(record => {
          const recordElement = document.createElement('pre');
          recordElement.textContent = JSON.stringify(record, null, 2);
          displayDiv.appendChild(recordElement);
        });
      } else {
        const recordElement = document.createElement('pre');
        recordElement.textContent = JSON.stringify(records, null, 2);
        displayDiv.appendChild(recordElement);
      }
    }
      
      async function fetchAllUserDiabetesRecords() {
        disableButton('fetchAllUserDiabetesButton');
        document.getElementById('fetchAllUserDiabetesLoadingIndicator').style.display = 'block';
        
        try {
          const response = await fetch('https://render-9r49.onrender.com/api/blockchain/diabetes/all-user-records', {
            headers: {
              "Authorization": `Bearer ${localStorage.getItem("accessToken")}`
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          displayRecords(data);
        } catch (error) {
          console.error('Error fetching user diabetes records:', error);
        } finally {
          enableButton('fetchAllUserDiabetesButton');
          document.getElementById('fetchAllUserDiabetesLoadingIndicator').style.display = 'none';
        }
      }
      
      async function fetchAllUserHeartRecords() {
        disableButton('fetchAllUserHeartButton');
        document.getElementById('fetchAllUserHeartLoadingIndicator').style.display = 'block';
        
        try {
          const response = await fetch('https://render-9r49.onrender.com/api/blockchain/heart/all-user-records', {
            headers: {
              "Authorization": `Bearer ${localStorage.getItem("accessToken")}`
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          displayRecords(data);
        } catch (error) {
          console.error('Error fetching user heart records:', error);
        } finally {
          enableButton('fetchAllUserHeartButton');
          document.getElementById('fetchAllUserHeartLoadingIndicator').style.display = 'none';
        }
      }
      
      async function fetchAllUserLungRecords() {
        disableButton('fetchAllUserLungButton');
        document.getElementById('fetchAllUserLungLoadingIndicator').style.display = 'block';
        
        try {
          const response = await fetch('https://render-9r49.onrender.com/api/blockchain/lung/all-user-records', {
            headers: {
              "Authorization": `Bearer ${localStorage.getItem("accessToken")}`
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          displayRecords(data);
        } catch (error) {
          console.error('Error fetching user lung records:', error);
        } finally {
          enableButton('fetchAllUserLungButton');
          document.getElementById('fetchAllUserLungLoadingIndicator').style.display = 'none';
        }
      }
  </script>
</html>

