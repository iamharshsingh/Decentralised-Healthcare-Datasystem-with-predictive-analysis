<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Medical Input & Blockchain Record Fetcher</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    body {
      background: #e3f2fd;
      color: #e3f2fd;
      display: flex;
      margin: 0;
      font-family: Arial, sans-serif;
    }

    .sidebar {
      width: 200px;
      background: #a2d2ff;
      color: #fff;
      padding: 20px;
      min-height: 100vh;
      border-radius: 6px;
      transition: background 0.3s ease;
    }

    .sidebar h2 {
      margin-top: 0;
      text-align: center;
      color: #2c3e50;
      font-size: 30px;
      font-family: 'Times New Roman', Times, serif;
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
    }

    .sidebar ul li {
      margin: 15px 0;
      cursor: pointer;
      padding: 10px;
      background: linear-gradient(135deg, #4f93ce, #285f8f);
      text-align: center;
      border-color: #1f1f1f;
      border-radius: 7px;
      transition: background-color 0.3s;
      border: #151515;
    }

    .sidebar ul li:hover {
      background-color: #3d566e;
    }

    .main-content {
      flex-grow: 1;
      padding-left: 20px;
    }

    .form-section {
      display: none;
      margin-bottom: 40px;
      background-color: #90e0ef;
      border: 1px solid #ddd;
      padding: 20px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .form-section.active {
      display: block;
    }

    .form-section h1 {
      margin-top: 0;
      color: #2c3e50;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #5e60ce;
    }

    .small-input {
      width: 10%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      background: #5b21d7;
      color: #a7ae1a;
    }

    .form-group button {
      background-color: #2c3e50;
      color: #fff;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .form-group button:hover {
      background-color: #34495e;
    }

    .blockchain-fetcher {
      margin-top: 20px;
      border-top: 1px dashed #ccc;
      padding-top: 15px;
    }

    .blockchain-fetcher button {
      background-color: #16a085;
      color: #fff;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .blockchain-fetcher button:hover {
      background-color: #1abc9c;
    }

    .loading-indicator {
      margin-top: 8px;
      display: inline-block;
      margin-left: 10px;
      display: none;
    }

    /* Chat icon button */
    #chat-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #007bff;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    #chat-toggle:hover { background: #0056b3; }

    /* Button panel container */
    #chat-panel {
      position: fixed;
      bottom: 90px;
      right: 20px;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      border-radius: 8px;
      overflow: hidden;
      display: none;
      z-index: 999;
    }

    /* Each option button */
    .chat-option {
      display: block;
      width: 200px;
      padding: 12px;
      border: none;
      background: #285f8f;
      cursor: pointer;
      text-align: left;
      font-size: 14px;
    }
    .chat-option:hover { background: #4f93ce, }

    /* Response display box */
    #chat-response {
      position: fixed; bottom: 90px; right: 230px;
      width: 250px; /* remove max-height */
      background:  rgb(255,255,255); 
      border-radius: 8px; 
      display: none; z-index: 998;
    }

    .response-message {
      background: #4f93ce;
      white-space: pre-line;            
      color: rgb(255,255,255);  
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 6px;
      font-size: 14px;
      line-height: 1.4;
    }
    .response-message:last-child {
      margin-bottom: 0;
    }

    .header{
      font-size: 30px;
      font-family: 'Times New Roman', Times, serif;
      color: #16a085;
    }
  </style>
</head>

<body>
  <!-- Side Navbar -->
  <div class="sidebar">
    <h2>Diseases</h2>
    <ul>
      <li onclick=" showForm('diabetesForm')">Diabetes</li>
      <li onclick="showForm('heartForm')">Heart</li>
      <li onclick="showForm('lungForm')">Lung Cancer</li>
      <li onclick="showForm('ckdForm')">Chronic Kidney </li>
      </ul>
  </div>

  <!-- Main Content Area -->
  <div class="main-content">
    <!-- Diabetes Form -->
    <section id="diabetesForm" class="form-section active">
      <div class="header"><h1>Diabetes</h1></div>
      <!-- Note: form id for submission is "basicForm" -->
      <form id="diabetesFormData">
        <div class="form-group">
          <label for="pregnancies">Pregnancies</label>
          <input type="number" id="pregnancies" name="pregnancies" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="glucose">Glucose</label>
          <input type="number" id="glucose" name="glucose" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="bloodPressure">Blood Pressure</label>
          <input type="number" id="bloodPressure" name="bloodPressure" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="skinThickness">Skin Thickness</label>
          <input type="number" id="skinThickness" name="skinThickness" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="insulin">Insulin</label>
          <input type="number" id="insulin" name="insulin" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="bmi">BMI</label>
          <input type="number" id="bmi" name="bmi" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="age">Age</label>
          <input type="number" id="age" name="age" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="diabetesPedigreeFunction">Diabetes Pedigree Function</label>
          <input type="number" id="diabetesPedigreeFunction" name="diabetesPedigreeFunction" value="0"
            class="small-input" />
        </div>
        <div class="form-group">
          <!-- Call submitForm with parameter "Diabetes" -->
          <button type="button" onclick="submitForm('Diabetes')">Submit Diabetes Data</button>
        </div>
      </form>
      <!-- Blockchain Fetcher for Diabetes -->
      <div class="blockchain-fetcher">
        <button type="button" id="fetchAllUserDiabetesButton" onclick="fetchAllUserDiabetesRecords()">Fetch Diabetes
          Blockchain Records</button>
        <div id="diabetesLoadingIndicator" class="loading-indicator"></div>
      </div>
    </section>

    <!-- Heart Form -->
    <section id="heartForm" class="form-section">
      <div class="header"><h1>Heart</h1></div>
      <!-- Note: form id for submission is "fullForm" -->
      <form id="heartFormData">
        <div class="form-group">
          <label for="feature1">Feature 1</label>
          <input type="number" id="feature1" name="feature1" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="feature2">Feature 2</label>
          <input type="number" id="feature2" name="feature2" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="feature3">Feature 3</label>
          <input type="number" id="feature3" name="feature3" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="feature4">Feature 4</label>
          <input type="number" id="feature4" name="feature4" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="feature5">Feature 5</label>
          <input type="number" id="feature5" name="feature5" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="feature6">Feature 6</label>
          <input type="number" id="feature6" name="feature6" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="feature7">Feature 7</label>
          <input type="number" id="feature7" name="feature7" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="feature8">Feature 8</label>
          <input type="number" id="feature8" name="feature8" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="feature9">Feature 9</label>
          <input type="number" id="feature9" name="feature9" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="feature10">Feature 10</label>
          <input type="number" id="feature10" name="feature10" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="feature11">Feature 11</label>
          <input type="number" id="feature11" name="feature11" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="feature12">Feature 12</label>
          <input type="number" id="feature12" name="feature12" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="feature13">Feature 13</label>
          <input type="number" id="feature13" name="feature13" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <!-- Call submitForm with parameter "Heart" -->
          <button type="button" onclick="submitForm('Heart')">Submit Heart Data</button>
        </div>
      </form>
      <!-- Blockchain Fetcher for Heart -->
      <div class="blockchain-fetcher">
        <button type="button" id="fetchAllUserHeartButton" onclick="fetchAllUserHeartRecords()">Fetch Heart Blockchain
          Records</button>
        <div id="heartLoadingIndicator" class="loading-indicator"></div>
      </div>
    </section>

    <!-- Lung Cancer Form -->
    <section id="lungForm" class="form-section">
      <div class="header"><h1>Lung Cancer</h1></div>
      <!-- Note: form id for submission is "lungFormData" -->
      <form id="lungFormData">
        <div class="form-group">
          <label for="AGE">Age </label>
          <input type="number" id="AGE" name="AGE" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="SMOKING">Smoking</label>
          <select id="SMOKING" name="SMOKING" class="small-input">
            <option value="NO" selected>No</option>
            <option value="YES">Yes</option>
          </select>
        </div>
        <div class="form-group">
          <label for="YELLOW_FINGERS">Yellow fingers</label>
          <select id="YELLOW_FINGERS" name="YELLOW_FINGERS" class="small-input">
            <option value="NO" selected>No</option>
            <option value="YES">Yes</option>
          </select>
        </div>
        <div class="form-group">
          <label for="ANXIETY">Anxiety</label>
          <select id="ANXIETY" name="ANXIETY" class="small-input">
            <option value="NO" selected>No</option>
            <option value="YES">Yes</option>
          </select>
        </div>
        <div class="form-group">
          <label for="PEER_PRESSURE">Peer Pressure</label>
          <select id="PEER_PRESSURE" name="PEER_PRESSURE" class="small-input">
            <option value="NO" selected>No</option>
            <option value="YES">Yes</option>
          </select>
        </div>
        <div class="form-group">
          <label for="CHRONIC_DISEASE">Chronic disease</label>
          <select id="CHRONIC_DISEASE" name="CHRONIC_DISEASE" class="small-input">
            <option value="NO" selected>No</option>
            <option value="YES">Yes</option>
          </select>
        </div>
        <div class="form-group">
          <label for="FATIGUE">Fatigue</label>
          <select id="FATIGUE" name="FATIGUE" class="small-input">
            <option value="NO" selected>No</option>
            <option value="YES">Yes</option>
          </select>
        </div>
        <div class="form-group">
          <label for="ALLERGY">Allergy</label>
          <select id="ALLERGY" name="ALLERGY" class="small-input">
            <option value="NO" selected>No</option>
            <option value="YES">Yes</option>
          </select>
        </div>
        <div class="form-group">
          <label for="WHEEZING">Wheezing</label>
          <select id="WHEEZING" name="WHEEZING" class="small-input">
            <option value="NO" selected>No</option>
            <option value="YES">Yes</option>
          </select>
        </div>
        <div class="form-group">
          <label for="ALCOHOL_CONSUMING">Alcohol Consuming</label>
          <select id="ALCOHOL_CONSUMING" name="ALCOHOL_CONSUMING" class="small-input">
            <option value="NO" selected>No</option>
            <option value="YES">Yes</option>
          </select>
        </div>
        <div class="form-group">
          <label for="COUGHING">Couching</label>
          <select id="COUGHING" name="COUGHING" class="small-input">
            <option value="NO" selected>No</option>
            <option value="YES">Yes</option>
          </select>
        </div>
        <div class="form-group">
          <label for="SHORTNESS_OF_BREATH">Shortness of breath</label>
          <select id="SHORTNESS_OF_BREATH" name="SHORTNESS_OF_BREATH" class="small-input">
            <option value="NO" selected>No</option>
            <option value="YES">Yes</option>
          </select>
        </div>
        <div class="form-group">
          <label for="SWALLOWING_DIFFICULTY">Swallowing difficulty</label>
          <select id="SWALLOWING_DIFFICULTY" name="SWALLOWING_DIFFICULTY" class="small-input">
            <option value="NO" selected>No</option>
            <option value="YES">Yes</option>
          </select>
        </div>
        <div class="form-group">
          <label for="CHEST_PAIN">Cheast Pain</label>
          <select id="CHEST_PAIN" name="CHEST_PAIN" class="small-input">
            <option value="NO" selected>No</option>
            <option value="YES">Yes</option>
          </select>
        </div>
        <div class="form-group">
          <!-- Call submitForm with parameter "Lung Cancer" -->
          <button type="button" onclick="submitForm('Lung')">Submit Lung Cancer Data</button>
        </div>
      </form>
      <!-- Blockchain Fetcher for Lung Cancer -->
      <div class="blockchain-fetcher">
        <button type="button" id="fetchAllUserLungButton" onclick="fetchAllUserLungRecords()">Fetch Lung Cancer
          Blockchain Records</button>
        <div id="lungLoadingIndicator" class="loading-indicator"></div>
      </div>
    </section>

    <!-- Chronic Kidney Disease Form -->
    <section id="ckdForm" class="form-section">
      <div class="header"><h1>Chronic Kidney</h1></div>
      <form id="ckdFormData">
        <!-- Numeric inputs -->
        <div class="form-group">
          <label for="age">Age</label>
          <input type="number" id="age" name="age" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="blood_pressure">Blood Pressure</label>
          <input type="number" id="blood_pressure" name="blood_pressure" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="specific_gravity">Specific Gravity</label>
          <input type="number" id="specific_gravity" name="specific_gravity" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="albumin">Albumin</label>
          <input type="number" id="albumin" name="albumin" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="sugar">Sugar</label>
          <input type="number" id="sugar" name="sugar" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="red_blood_cells">Red Blood Cells</label>
          <input type="number" id="red_blood_cells" name="red_blood_cells" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="pus_cell">Pus Cell</label>
          <input type="number" id="pus_cell" name="pus_cell" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="pus_cell_clumps">Pus Cell Clumps</label>
          <input type="number" id="pus_cell_clumps" name="pus_cell_clumps" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="bacteria">Bacteria</label>
          <input type="number" id="bacteria" name="bacteria" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="blood_glucose_random">Blood Glucose Random</label>
          <input type="number" id="blood_glucose_random" name="blood_glucose_random" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="blood_urea">Blood Urea</label>
          <input type="number" id="blood_urea" name="blood_urea" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="serum_creatinine">Serum Creatinine</label>
          <input type="number" id="serum_creatinine" name="serum_creatinine" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="sodium">Sodium</label>
          <input type="number" id="sodium" name="sodium" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="potassium">Potassium</label>
          <input type="number" id="potassium" name="potassium" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="haemoglobin">Haemoglobin</label>
          <input type="number" id="haemoglobin" name="haemoglobin" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="packed_cell_volume">Packed Cell Volume</label>
          <input type="number" id="packed_cell_volume" name="packed_cell_volume" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="white_blood_cell_count">White Blood Cell Count</label>
          <input type="number" id="white_blood_cell_count" name="white_blood_cell_count" value="0"
            class="small-input" />
        </div>
        <div class="form-group">
          <label for="red_blood_cell_count">Red Blood Cell Count</label>
          <input type="number" id="red_blood_cell_count" name="red_blood_cell_count" value="0" class="small-input" />
        </div>
        <!-- Boolean inputs as 0/1 -->
        <div class="form-group">
          <label for="hypertension">Hypertension</label>
          <input type="number" id="hypertension" name="hypertension" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="diabetes_mellitus">Diabetes Mellitus</label>
          <input type="number" id="diabetes_mellitus" name="diabetes_mellitus" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="coronary_artery_disease">Coronary Artery Disease</label>
          <input type="number" id="coronary_artery_disease" name="coronary_artery_disease" value="0"
            class="small-input" />
        </div>
        <div class="form-group">
          <label for="appetite">Appetite</label>
          <input type="number" id="appetite" name="appetite" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="peda_edema">Pedal Edema</label>
          <input type="number" id="peda_edema" name="peda_edema" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <label for="aanemia">Aanemia</label>
          <input type="number" id="aanemia" name="aanemia" value="0" class="small-input" />
        </div>
        <div class="form-group">
          <button type="button" onclick="submitForm('ckd')">Submit CKD Data</button>
        </div>
      </form>


      <!-- Blockchain Fetcher for CKD -->
      <div class="blockchain-fetcher">
        <button type="button" id="fetchAllUserCkdButton" onclick="fetchAllUserCkdRecords()">
          Fetch CKD Blockchain Records
        </button>
        <div id="ckdLoadingIndicator" class="loading-indicator"></div>
      </div>
    </section>

    <!-- Prediction Result Display -->
    <section id="predictionResult" class="prediction-result" style="display: none;">
      <h3>Prediction Result</h3>
      <p id="predictionText"></p>
    </section>

    <!-- Record Display for Blockchain Data -->
    <section id="recordDisplay" class="record-display"></section>
  </div>

    <!-- Chat Icon -->
    <div id="chat-toggle">üí¨</div>
    <!-- Chat Panel -->
    <div id="chat-panel">
      <button class="chat-option" data-value="Medicine" data-endpoint="/api/chat/diabetes">Medicine</button>
      <button class="chat-option" data-value="Exercise" data-endpoint="/api/chat/heart">Exercise</button>
      <button class="chat-option" data-value="Home Cure" data-endpoint="/api/chat/diabetes">Home Cure</button>
      <button class="chat-option" data-value="Diet" data-endpoint="/api/chat/heart">Diet</button>
      <button class="chat-option" data-value="Doctor Type" data-endpoint="/api/chat/diabetes">Doctor Type</button>
    </div>
    <!-- Chat Response -->
    <div id="chat-response"></div>

  <!-- JavaScript Functionality -->
  <script>
    // Check if the access token exists
    const token = localStorage.getItem("accessToken");
    if (!token) {
      alert("You must log in first!");
      window.location.href = "login.html";
   }

    let lastSubmittedData = null;
    let isSubmitting = false;

    function showForm(sectionId) {
      const sections = document.querySelectorAll('.form-section');
      sections.forEach(section => section.classList.remove('active'));
      document.getElementById(sectionId).classList.add('active');
    }
    async function submitForm(formType) {
      let form, apiUrl, loadingIndicatorId;

      if (formType === "Diabetes") {
        form = document.getElementById("diabetesFormData");
        apiUrl = "https://render-1-yyer.onrender.com/predict/diabetes";
        loadingIndicatorId = "diabetesLoadingIndicator";
      } else if (formType === "Heart") {
        form = document.getElementById("heartFormData");
        apiUrl = "https://render-1-yyer.onrender.com/predict/heart";
        loadingIndicatorId = "heartLoadingIndicator";
      } else if (formType === "Lung") {
        form = document.getElementById("lungFormData");
        apiUrl = "https://render-1-yyer.onrender.com/predict/lung";
        loadingIndicatorId = "lungLoadingIndicator";
      } else if (formType === "ckd") {
        form = document.getElementById("ckdFormData");
        apiUrl = "https://render-1-yyer.onrender.com/predict/chronic";
        loadingIndicatorId = "ckdLoadingIndicator";
      } else {
        alert("Invalid form type");
        return;
      }

      const formData = new FormData(form);
      const raw = Object.fromEntries(formData.entries());
      let data;


      if (formType === "ckd") {
        console.log("Raw CKD form data:", raw);
        data = Object.fromEntries(
          Object.entries(raw).map(([k, v]) => [k, Number(v)])
        );
        console.log("CKD Data:", data);
      } else {
        data = {};
        for (let [k, v] of Object.entries(raw)) {
          data[k] = isNaN(v) ? v : Number(v);
        }
      }


      if (formType === "Lung") {
        for (let key in data) {
          if (typeof data[key] === 'string') {
            let trimmedValue = data[key].trim().toUpperCase();
            data[key] = trimmedValue === "YES" ? 1 : trimmedValue === "NO" ? 0 : data[key];
          }
        }
        console.log("Lung Cancer Data:", data);
      }

      try {
        document.getElementById(loadingIndicatorId).style.display = 'block';

        const response = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const errorResponse = await response.text();
          throw new Error(`HTTP error! Status: ${response.status}. Response: ${errorResponse}`);
        }

        const result = await response.json();
        console.log("Response from server:", result);


        if (formType === "Lung") {
          if (result.LUNG_CANCER === "YES") {
            result.LUNG_CANCER = 1;
          }
          else {
            result.LUNG_CANCER = 0;
          }
        }

        if (formType === "ckd") {
          if (result.CHRONIC_DISEASE === "YES") {
            result.prediction = 1;
          }
          else {
            result.prediction = 0;
          }
        }


        if (result.LUNG_CANCER !== undefined || result.prediction !== undefined) {
           const predictionValue = result.LUNG_CANCER !== undefined ? result.LUNG_CANCER || result.CHRONIC_DISEASE : result.prediction;

          if (predictionValue !== 0 && predictionValue !== 1) {
            alert(`Unexpected response from server:\n${JSON.stringify(result)}`);
            return;
          }


          if (hasDataChanged(data, predictionValue)) {
            const predictionResult = document.getElementById('predictionResult');
            const predictionText = document.getElementById('predictionText');
            predictionResult.style.display = 'none';
            console.log("Prediction Value:", predictionValue);
            if (!isSubmitting) {
              isSubmitting = true;

              const returnHash = await storePredictionOnBlockchain(data, predictionValue, formType);
              if (!returnHash) {
                console.log("Prediction not stored on blockchain");
              } else {
                console.log("Prediction stored successfully on blockchain");
              }

              let predictionMsg = "";
              if (formType === "Diabetes") {
                predictionMsg = result.prediction === 1 ? 'Patient has diabetes' : 'Patient is healthy';
              } else if (formType === "Heart") {
                predictionMsg = result.prediction === 1 ? 'Patient has heart disease' : 'Patient is healthy';
              } else if (formType === "Lung") {
                predictionMsg = result.prediction === 1 ? 'Patient has lung cancer' : 'Patient is healthy';
              } else if (formType === "ckd") {
                predictionMsg = result.prediction === 1 ? "Patient has chronic kidney disease" : "Patient is healthy";
              }
              document.getElementById('predictionText').textContent = predictionMsg;
              document.getElementById('predictionResult').style.display = 'block';

              lastSubmittedData = { ...data, prediction: result.prediction };
            } else {
              alert("Submission already in progress, please wait.");
            }
          } else {
            alert("No change in data, not submitting to blockchain.");
          }
        } else {
          alert(`Error: ${result.error}`);
        }
      } catch (error) {
        console.error("Error while submitting form:", error);
        alert('Failed to submit the form. Please try again.');
      } finally {
        // Hide loading indicator and reset isSubmitting flag
        document.getElementById(loadingIndicatorId).style.display = 'none';
        isSubmitting = false;
      }
    }

    function hasDataChanged(currentData, prediction) {
      const currentDataWithPrediction = { ...currentData, prediction };
      if (!lastSubmittedData) {
        return true;
      }
      return JSON.stringify(currentDataWithPrediction) !== JSON.stringify(lastSubmittedData);
    }

    async function refreshToken() {
      try {
        console.log("üîÑ Attempting to refresh access token...");
        const response = await fetch("https://render-9r49.onrender.com/api/user/refresh", {
          method: "POST",
          credentials: "include"
        });
        if (!response.ok) {
          console.error("Refresh token request failed:", response.status);
          return false;
        }
        const { accessToken } = await response.json();
        console.log("‚úÖ New access token received:", accessToken);
        localStorage.setItem("accessToken", accessToken);
        return true;
      } catch (error) {
        console.error("‚ùå Error refreshing token:", error);
        return false;
      }
    }

    function isTokenExpired(token) {
      try {
        const payload = JSON.parse(atob(token.split(".")[1]));
        return payload.exp * 1000 < Date.now();
      } catch (error) {
        console.error("Error decoding token:", error);
        return true;
      }
    }

    // Store prediction on blockchain with token handling
    async function storePredictionOnBlockchain(formData, prediction, formType) {
      let token = localStorage.getItem("accessToken");
      if (!token) {
        alert("Session expired. Please log in again.");
        window.location.href = "login.html";
        return;
      }
      console.log("Using Access Token:", token);
      if (isTokenExpired(token)) {
        console.log("Token is expired, refreshing...");
        const refreshSuccess = await refreshToken();
        if (!refreshSuccess) {
          alert("Session expired. Please log in again.");
          window.location.href = "login.html";
          return;
        }
        token = localStorage.getItem("accessToken");
      }
      try {
        console.log("Storing data on blockchain...");
        let dataToStore;
        if (formType === "ckd") {
          const SNAKE_TO_CAMEL = {
            age:                    'age',
            blood_pressure:         'bloodPressure',
            specific_gravity:       'specificGravity',
            albumin:                'albumin',
            sugar:                  'sugar',
            red_blood_cells:        'redBloodCells',
            pus_cell:               'pusCell',
            pus_cell_clumps:        'pusCellClumps',
            bacteria:               'bacteria',
            blood_glucose_random:   'bloodGlucoseRandom',
            blood_urea:             'bloodUrea',
            serum_creatinine:       'serumCreatinine',
            sodium:                 'sodium',
            potassium:              'potassium',
            haemoglobin:            'haemoglobin',
            packed_cell_volume:     'packedCellVolume',
            white_blood_cell_count: 'whiteBloodCellCount',
            red_blood_cell_count:   'redBloodCellCount',
            hypertension:           'hypertension',
            diabetes_mellitus:      'diabetesMellitus',
            coronary_artery_disease:'coronaryArteryDisease',
            appetite:               'appetite',
            peda_edema:             'pedaEdema',
            aanemia:                'aanemia'   
          };

          dataToStore = Object.fromEntries(
            Object.entries(formData).map(([snakeKey, value]) => {
              const camelKey = SNAKE_TO_CAMEL[snakeKey];
              return [camelKey, value];
            })
          );
          dataToStore.prediction = prediction;
      
        } else {
          dataToStore = { ...formData, prediction };
        }
       // const dataToStore = { ...formData, prediction };
        console.log("Data to store on blockchain:", dataToStore);
        console.log("Data to store on blockchain:", JSON.stringify(dataToStore, null, 2));
        let blockchainUrl = "";
        if (formType === "Diabetes") {
          blockchainUrl = "https://render-9r49.onrender.com/api/blockchain/store-diabetes";
        } else if (formType === "Heart") {
          blockchainUrl = "https://render-9r49.onrender.com/api/blockchain/store-heart";
        } else if (formType === "Lung") {
          blockchainUrl = "https://render-9r49.onrender.com/api/blockchain/store-lung";
        } else if (formType === "ckd") {
          blockchainUrl = "https://render-9r49.onrender.com/api/blockchain/store-ckd";
        }
        const blockchainResponse = await fetch(blockchainUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify([dataToStore])
        });
        if (blockchainResponse.status === 401) {
          console.log("Access token expired, trying to refresh...");
          const refreshSuccess = await refreshToken();
          if (refreshSuccess) {
            return storePredictionOnBlockchain(formData, prediction, formType);
          } else {
            alert("Session expired. Please log in again.");
            window.location.href = "login.html";
            return;
          }
        }
        if (!blockchainResponse.ok) {
          const errorResponse = await blockchainResponse.text();
          console.error("Error response from blockchain:", errorResponse);
          throw new Error("Failed to store data on the blockchain.");
        }
        const blockchainResult = await blockchainResponse.json();
        console.log("Data stored successfully on the blockchain:", blockchainResult);
        return blockchainResult;
      } catch (error) {
        console.error("Error storing data on the blockchain:", error);
        alert("Failed to store data on the blockchain. Please try again.");
      }
    }

    // Chat functionality
  const toggle      = document.getElementById('chat-toggle');
  const panel       = document.getElementById('chat-panel');
  const responseBox = document.getElementById('chat-response');

  // Track last section for form‚Äêspecific clearing
  let lastSection = null;

  // Toggle panel & hide responses on close
  toggle.addEventListener('click', () => {
    const open = panel.style.display === 'block';
    panel.style.display       = open ? 'none' : 'block';
    responseBox.style.display = open ? 'none' : responseBox.style.display;
    if (!open) {
      // If opening, clear old messages
      responseBox.innerHTML = '';
    }
  });

  function formatResponse(raw) {
    // 1) strip **bold**
    let s = raw.replace(/\*\*(.*?)\*\*/g, '$1');
    // 2) Break before any dash-list (colon-dash or plain dash)
    s = s
      .replace(/:\s*-\s*/g, ':\n- ')   // after ‚ÄúOptions: - ‚Äù
      .replace(/\s*-\s*/g, '\n- ')     // any other ‚Äú - ‚Äù
      .trim();
    return s;
  }

  // Display a single ‚Äúbubble‚Äù message
  function showResponse(text) {
    const clean = formatResponse(text);
    const msg   = document.createElement('div');
    msg.className   = 'response-message';
    msg.textContent = clean;
    responseBox.appendChild(msg);
    responseBox.style.display = 'block';
  }

  // Map your form-section IDs to endpoint suffixes
  const diseaseMap = {
    diabetesForm: 'diabetes',
    heartForm:    'heart',
    lungForm:     'lung',
    ckdForm:      'ckd'
  };

  panel.addEventListener('click', async (e) => {
    if (!e.target.classList.contains('chat-option')) return;

    // 1) Clear out any existing bubble immediately
    responseBox.innerHTML     = '';
    responseBox.style.display = 'block';

    // 2) Determine which disease form is active
    const active = document.querySelector('.form-section.active');
    if (!active) {
      return showResponse('‚ö†Ô∏è No active form found.');
    }
    const secId   = active.id;
    const disease = diseaseMap[secId];
    if (!disease) {
      return showResponse(`‚ö†Ô∏è Unknown section "${secId}"`);
    }

    // 3) If we've just switched forms, ensure a clean slate
    if (lastSection !== secId) {
      responseBox.innerHTML = '';
      lastSection = secId;
    }

    // 4) Send the request
    const option = e.target.dataset.value;
    const url    = `https://render-1-yyer.onrender.com/api/chat/${disease}`;
    try {
      const res = await fetch(url, {
        method:  'POST',
        headers: { 'Content-Type': 'application/json' },
        body:    JSON.stringify({ input: option })
      });
      if (!res.ok) {
        const errTxt = await res.text();
        throw new Error(`${res.status} ${errTxt}`);
      }
      const { response, error } = await res.json();
      showResponse(response || `‚ö†Ô∏è ${error}`);
    } catch (err) {
      console.error(err);
      showResponse(`‚ùå Network error: ${err.message}`);
    }
  });


  
    

    function showForm(id) {
      document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    // Utility functions for disabling/enabling buttons
    function disableButton(buttonId) {
      const button = document.getElementById(buttonId);
      if (!button) {
        console.warn(`Element with id "${buttonId}" not found.`);
        return;
      }
      button.disabled = true;
    }

    function enableButton(buttonId) {
      const button = document.getElementById(buttonId);
      button.disabled = false;
    }

    // Display blockchain records in a table format
    function displayRecords(records) {
      const displayDiv = document.getElementById('recordDisplay');
      displayDiv.innerHTML = ''; // Clear previous content

      if (Array.isArray(records)) {
        if (records.length === 0) {
          displayDiv.textContent = 'No data available';
          return;
        }
        const table = document.createElement('table');
        const headerRow = document.createElement('tr');
        Object.keys(records[0]).forEach(key => {
          const th = document.createElement('th');
          th.textContent = key;
          headerRow.appendChild(th);
        });
        table.appendChild(headerRow);

        records.forEach(record => {
          const row = document.createElement('tr');
          Object.values(record).forEach(value => {
            const td = document.createElement('td');
            td.textContent = value;
            row.appendChild(td);
          });
          table.appendChild(row);
        });
        displayDiv.appendChild(table);
      } else {
        const pre = document.createElement('pre');
        pre.textContent = JSON.stringify(records, null, 2);
        displayDiv.appendChild(pre);
      }
    }

    async function fetchAllUserDiabetesRecords() {
      disableButton('fetchAllUserDiabetesButton');
      document.getElementById('diabetesLoadingIndicator').style.display = 'block';
      try {
        const response = await fetch('https://render-9r49.onrender.com/api/blockchain/diabetes/all-user-records', {
          headers: {
            "Authorization": `Bearer ${localStorage.getItem("accessToken")}`
          }
        });
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        displayRecords(data.records);
      } catch (error) {
        console.error('Error fetching user diabetes records:', error);
      } finally {
        enableButton('fetchAllUserDiabetesButton');
        document.getElementById('diabetesLoadingIndicator').style.display = 'none';
      }
    }



    async function fetchAllUserHeartRecords() {
      disableButton('fetchAllUserHeartButton');
      document.getElementById('heartLoadingIndicator').style.display = 'block';
      try {
        const response = await fetch('https://render-9r49.onrender.com/api/blockchain/heart/all-user-records', {
          headers: {
            "Authorization": `Bearer ${localStorage.getItem("accessToken")}`
          }
        });
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        displayRecords(data.records);
      } catch (error) {
        console.error('Error fetching user heart records:', error);
      } finally {
        enableButton('fetchAllUserHeartButton');
        document.getElementById('heartLoadingIndicator').style.display = 'none';
      }
    }

    async function fetchAllUserLungRecords() {
      disableButton('fetchAllUserLungButton');
      document.getElementById('lungLoadingIndicator').style.display = 'block';
      try {
        const response = await fetch('https://render-9r49.onrender.com/api/blockchain/lung/all-user-records', {
          headers: {
            "Authorization": `Bearer ${localStorage.getItem("accessToken")}`
          }
        });
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        displayRecords(data.records);
      } catch (error) {
        console.error('Error fetching user lung records:', error);
      } finally {
        enableButton('fetchAllUserLungButton');
        document.getElementById('lungLoadingIndicator').style.display = 'none';
      }
    }

    async function fetchAllUserCkdRecords() {
      disableButton('fetchAllUserCkdButton');
      document.getElementById('ckdLoadingIndicator').style.display = 'block';
    
      try {
        const response = await fetch('https://render-9r49.onrender.com/api/blockchain/ckd/all-user-records', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          }
        });
    
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
    
        const data = await response.json();
        // If you need a separate renderer, swap this out:
        displayRecords(data.records);
      } catch (error) {
        console.error('Error fetching user CKD records:', error);
        alert('Failed to fetch CKD records. Please try again.');
      } finally {
        enableButton('fetchAllUserCkdButton');
        document.getElementById('ckdLoadingIndicator').style.display = 'none';
      }
    }
    
  </script>
</body>

</html>